---
title: "EDUC 152. Intro to quantitative research in education: Regression analysis"
subtitle: "Multivariate regression"
author: 
date: 
urlcolor: blue
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true # toc_float option to float the table of contents to the left of the main document content. floating table of contents will always be visible even when the document is scrolled
      #collapsed: false # collapsed (defaults to TRUE) controls whether the TOC appears with only the top-level (e.g., H2) headers. If collapsed initially, the TOC is automatically expanded inline when necessary
      #smooth_scroll: true # smooth_scroll (defaults to TRUE) controls whether page scrolls are animated when TOC items are navigated to via mouse clicks
    number_sections: true
    fig_caption: true # ? this option doesn't seem to be working for figure inserted below outside of r code chunk    
    highlight: tango # Supported styles include "default", "tango", "pygments", "kate", "monochrome", "espresso", "zenburn", and "haddock" (specify null to prevent syntax    
    theme: default # theme specifies the Bootstrap theme to use for the page. Valid themes include default, cerulean, journal, flatly, readable, spacelab, united, cosmo, lumen, paper, sandstone, simplex, and yeti.
    df_print: tibble #options: default, tibble, paged
bibliography: ../../assets/bib/educ152_bib.bib
csl: ../../assets/bib/apa.csl
---


<!-- Code to enable scroll right for printing of data frames -->
<style>
pre code, pre, code {
  white-space: pre !important;
  overflow-x: auto !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>


```{r, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", highlight = TRUE, warning = FALSE, message = FALSE)
  #comment = "#>" makes it so results from a code chunk start with "#>"; default is "##"
#options(scipen=999)
options(tibble.width = Inf, width = 10000) # Code necessary to enable scroll right for printing of data frames

# remove scientific notation
options(scipen=999)

# add commas to big numbers
#knitr::kable(d, digits = 3, format.args = list(big.mark = ",", scientific = FALSE))
```

# Introduction

"Bivariate regression" refers to regression models with two variables, a $Y$ variable ("dependent variable" or "outcome") and a single $X$ variable ("independent variable")

<br>

"Multivariate regression" refers to regression models with a $Y$ variable and two or more $X$ variables

<br>

This lecture introduces multivariate regression, building on concepts we learned from lecture on bivariate regression. In particular, this lecture will focus on:

- Assumptions required to make inferences based on regression analysis
- Using multivariate regression to estimate causal effects
- Interpreting results from multivariate regresssion
  - interpreting regression output from *R*
  - interpreting results from publications that use regresion



## Libraries, data, functions


This lecture will utilize data from two sources: The Educational Longitudinal Study (ELS) of 2002;  Tennessee Student Teacher Achievement Ratio (STAR) experiment

<br>

The Educational Longitudinal Study (ELS) of 2002, referred to as ELS:2002

- Nationally representative, longitudinal survey of US 10th graders in 2002, followed them from 2002 to 2013
- Created by the National Center for Education Statistics, a branch of the U.S. Department of Education
- [LINK](https://nces.ed.gov/surveys/els2002/) to ELS:2002 website
- [LINK](https://nces.ed.gov/OnlineCodebook) to the NCES "Online Codebook"  website, which contains "public-use" versions of ELS datasets and detailed information about all variables
  - variables that could potentially be used to identify ELS survey respondents are "suppressed" from public-use datasets
  - these variables are present in "restricted" versions of ELS datasets

  
<br>  

Tennessee Student Teacher Achievement Ratio (STAR) experiment, 

- Tennessee STAR experiment sought to analyze the effect of elementary school students being randomly assigned to a a "small" class size ($T_i=1$) vs. "large" class size ($T_i=0$) on academic achievement ($Y$)
- [LINK](https://dataverse.harvard.edu/dataset.xhtml?persistentId=hdl:1902.1/10766) to information and data on the Tennessee STAR project


```{r}
# uncomment below line to remove all objects
  rm(list = ls())

# Libraries

  # install packages if you haven't already
    #install.packages('tidyverse')
    #install.packages('labelled')
    #install.packages('haven')
    #install.packages('patchwork')

  library(tidyverse)
  library(labelled)
  library(haven)
  #library(patchwork)

##########
########## TENNESSEE STAR DATA
##########

# load star data
load(file = url('https://github.com/anyone-can-cook/educ152/raw/main/data/star/star_panel_data.RData'))

#df_star_panel %>% glimpse()

# create data frame for STAR experiment, keeping only kindergarten
df_stark <- df_star_panel %>% 
  # keep only kindergarten year
  filter(grade ==1) %>% 
  # keep only observations with non-missing value for reading score
  filter(!is.na(read)) %>%
  # keep only observations with non-missing values for treatment assignment
  filter(!is.na(star)) %>%
  # drop observations where treatment status is regular+aide
  filter(star !=3) %>%
  # keep selected variables
  select(id,grade,star,read,gender,ethnicity,lunch,school,degree,experience) %>%
  # create a variable "treatment" that equals 1 if student receives treatment (small class) and equals 0 otherwise
  mutate(
    treatment = if_else(star==2,1,0)
  )

df_stark %>% glimpse()

rm(df_star_panel) # comment this line out if you want to keep data frame df_star_panel

##########
########## ELS:2002 data
##########

# RUN SCRIPT THAT CREATES STUDENT-LEVEL DATA FRAME CONTAINING ALL VARIABLES AND CREATES DATA FRAME WITH A SUBSET OF VARIABLES

  #NOTE: this script will take 30 seconds to a minute to run because loading a dataset w/ about 16,000 observations and 4,000 variables from a website

  #source(file = url('https://github.com/anyone-can-cook/educ152/raw/main/scripts/els/read_els_by_pets.R'))
    source(file = file.path('.','..','..','scripts','els','read_els_by_pets.R'))
      #list.files(path = file.path('.','..','..','scripts','els'))

# Create a dataframe df_els_stu_fac that has categorical variables as factor class variables rather than labelled class variables
  df_els_stu_fac <- as_factor(df_els_stu, only_labelled = TRUE)

##########
########## RUN SCRIPT THAT CREATES USER DEFINED FUNCTIONS
##########

# source(file = url('https://github.com/anyone-can-cook/educ152/raw/main/scripts/user_defined_functions/create_inference_functions.R'))
  
  
```


## ELS:2002 data

For the ELS:2002 data, we will initially focus on sample of students who enrolled in postsecondary education at some point from 2004 to 2013 but who did not begin at a 4-year public or a 4-year private non-profit university  

- The instructors want your help in choosing variables of interest and sample of interest!

ELS datasets we created

- student-level data frame `df_els_stu_all` has all variables (about 4,000) and all observations (about 16,200 observations); one observation for each student
- student-level data frame `df_els_stu` has a subset of variables; contains students who started postsecondary education at a 2-yr, less-than-2-yr, or a for-profit institution (and some other criteria)
- for both `df_els_stu_all` and `df_els_stu`, most categorical variables are `labelled` class variables
- student-level data frame `df_els_stu_fac` is exact same as `df_els_stu` except categorical variables are `factor` class; categorical variables must be factor class when running regression models


Investigate `df_els_stu`
```{r}
# variable names
df_els_stu %>% glimpse()

# variable labels
df_els_stu %>% var_label()
```
Can use the `lookfor()` function from the `labelled` package to query which variables and variable labels contain certain words

- syntax (with defaults):
  - `look_for(data, ..., labels = TRUE, ignore.case = TRUE, details = TRUE)`
  - where argument `...` contains "strings" (e.g., words) you are looking for, enclosed in quotation marks
- example syntax, looking for variable names and variable labels that contain the word "internship"
  - `lookfor(data=df_els_stu_all, 'internship',labels = TRUE, ignore.case = TRUE, details = TRUE)`


useful to use `lookfor()` to query the dataset `df_els_stu_all` because this dataset has so many variables (more than 4,000)
```{r}

# query data frame df_els_stu_all
  lookfor(data=df_els_stu_all, 'internship',labels = TRUE, ignore.case = TRUE, details = TRUE)


# query data frame df_els_stu_all
  lookfor(data=df_els_stu, 'debt',labels = TRUE, ignore.case = TRUE, details = TRUE)
  lookfor(data=df_els_stu, 'loan',labels = TRUE, ignore.case = TRUE, details = TRUE)
```

# OLS Assumptions

## Bias and efficiency

Efficiency, also called "precision"

- Desirable properties of our point estimates (e.g. $\hat{\beta}$ or $\bar{Y}$)
  - Efficient
  - Unbiased
- __Efficiency__
  - Definition: how close your point estimate(s) is to the population parameter
  - Standard Error: on average, how far away is a point estimate from one random sample from the value of the population parameter
  - _Therefore_, an efficient point estimate is one with a low standard error (in other words, the sampling distribution of $\beta_1$ has low variance or is "tight" around the population parameter)
  
![](precision.png)

__Bias__

- __Bias__: consistently overestimates or underestimates population parameter in repeated random samples
  - There are many different types of bias!
- _Sampling Bias_:
  - Estimate of population parameter is biased because you fail to take a random sample
  - Example: goal is to estimate high school graduation rate; take a random sample of 10th graders and see if they graduate within three years.
- _Omitted variable bias_:
  - Bias in estimate of $\beta_1$ due to omitting necessary "control" variables in your regression model
  
![](bias.png)

Picture of Bias and Efficiency (or "Precision")

![](bias_efficiency.png)


## Assumption 2: i.i.d.

text

## Assumption 3: outliers

text

## Assumption 4: homoskedasticity

text

## Assumption 1: conditional independence assumption

text

# Omitted variable bias


# Independent variables for causal effects

text

  
# References